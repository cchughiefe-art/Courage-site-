<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Family Heritage</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --bg: #fdf5e6; --text: #5d4037; --line: #8d775f; --card: #fff; }
        body.dark { --bg: #121212; --text: #e0e0e0; --line: #8d775f; --card: #1e1e1e; }
        body { background: var(--bg); color: var(--text); font-family: 'Georgia', serif; margin: 0; transition: background 0.4s; }
        
        #mapView { width: 100vw; height: 100vh; display: none; position: fixed; top: 0; z-index: 100; }
        #viewer { width: 100%; min-height: 100vh; display: flex; justify-content: center; padding: 100px 0; overflow-x: auto; }
        
        .tree ul { display: flex; justify-content: center; padding-top: 30px; }
        .tree li { position: relative; padding: 30px 10px 0 10px; list-style: none; }
        .tree li::before, .tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 2px solid var(--line); width: 50%; height: 30px; }
        .tree li::after { right: auto; left: 50%; border-left: 2px solid var(--line); }
        .tree li:only-child::after, .tree li:only-child::before, .tree li:first-child::before, .tree li:last-child::after { display: none; }
        .tree ul ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 2px solid var(--line); height: 30px; }

        .card { border: 3px solid var(--line); padding: 15px; border-radius: 12px; background: var(--card); min-width: 140px; cursor: pointer; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .card img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 5px; }

        .ui { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 1000; }
        .btn { background: var(--line); color: white; border: none; padding: 12px 25px; border-radius: 30px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div id="mapView"></div>
    <div id="viewer"><div id="treeRoot" class="tree"></div></div>
    
    <div class="ui">
        <button class="btn" onclick="toggleTheme()">üåì Dark/Light</button>
        <button class="btn" onclick="toggleView()">üó∫Ô∏è Open Map</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-firestore.js";
        
        const db = getFirestore(initializeApp({ apiKey: "AIzaSyD00bj-hV8VSdJxAyCdqqpT7VWDMb9qNTQ", projectId: "family-tree-aec4a" }));
        let familyData = [], map, markers = [];

        // Dark Mode Logic
        window.toggleTheme = () => {
            document.body.classList.toggle('dark');
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        };
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');

        // Automatic GPS Sync
        onSnapshot(collection(db, "family"), (snap) => {
            familyData = []; snap.forEach(d => familyData.push({ id: d.id, ...d.data() }));
            renderTree();
        });

        function renderTree() {
            const root = document.getElementById('treeRoot'); root.innerHTML = '';
            const build = (pId) => {
                const kids = familyData.filter(m => m.parentId === pId && !familyData.find(x => x.spouseId === m.id));
                if (!kids.length) return '';
                let html = '<ul>';
                kids.forEach(k => {
                    const sp = familyData.find(x => x.spouseId === k.id || k.spouseId === x.id);
                    const card = (m) => `<div class="card" onclick="alert('${m.name}')">
                        ${m.photo ? `<img src="${m.photo}"><br>` : ''}<b>${m.name}</b></div>`;
                    html += `<li><div style="display:flex; gap:10px; justify-content:center;">${card(k)}${sp ? card(sp) : ''}</div>${build(k.id)}</li>`;
                });
                return html + '</ul>';
            };
            root.innerHTML = build("");
        }

        window.toggleView = () => {
            const mDiv = document.getElementById('mapView');
            mDiv.style.display = mDiv.style.display === 'none' ? 'block' : 'none';
            if(mDiv.style.display === 'block') {
                if(!map) { 
                    map = L.map('mapView').setView([0, 0], 2);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                }
                map.invalidateSize();
                markers.forEach(m => map.removeLayer(m));
                familyData.forEach(p => {
                    if(p.lat && p.lng) markers.push(L.marker([p.lat, p.lng]).addTo(map).bindPopup(p.name));
                });
            }
        };
    </script>
</body>
</html>

