<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Family Tree</title>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;700&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Crimson Text', serif;
    background: #f4f1ea;
    color: #333;
    padding: 20px;
    transition: background 0.3s, color 0.3s;
    text-align: center;
  }

  h2 {
    font-weight: 700;
    margin-bottom: 30px;
  }

  .tree {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .spouse {
    display: flex;
    gap: 20px;
    position: relative;
    justify-content: center;
  }

  .person {
    border: 1px solid #333;
    border-radius: 8px;
    padding: 10px;
    min-width: 100px;
    text-align: center;
    background: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
  }

  .person img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 50%;
    margin-bottom: 5px;
  }

  .children {
    display: flex;
    justify-content: center;
    margin-top: 20px;
    position: relative;
  }

  .line-vertical {
    position: absolute;
    width: 2px;
    background: #333;
    top: -20px;
    bottom: 0;
    left: 50%;
  }

  .line-horizontal {
    position: absolute;
    height: 2px;
    background: #333;
    top: 0;
    left: 0;
    right: 0;
    margin: auto;
  }

  .controls {
    margin-top: 40px;
  }

  button {
    margin: 0 10px;
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    background: #333;
    color: #fff;
    font-weight: 600;
    transition: 0.2s;
  }

  button:hover {
    background: #555;
  }
</style>
</head>
<body>

<h2>Family Tree</h2>

<div class="tree" id="familyTree"></div>

<div class="controls">
    <button id="toggleTheme">Toggle Day/Night</button>
    <button id="adminPage">Admin Page</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

// Firebase
const app = initializeApp({
  apiKey: "AIzaSyD00bj-hV8VSdJxAyCdqqpT7VWDMb9qNTQ",
  projectId: "family-tree-aec4a"
});
const db = getFirestore(app);

let people = [];
let displayed = new Set();

// Day/Night toggle
let darkMode = false;
document.getElementById('toggleTheme').addEventListener('click', () => {
    darkMode = !darkMode;
    document.body.style.background = darkMode ? '#333' : '#f4f1ea';
    document.body.style.color = darkMode ? '#f4f1ea' : '#333';
});

// Admin page
document.getElementById('adminPage').addEventListener('click', () => {
    window.location.href = 'add-family.html';
});

// Helper to get children
function getChildren(parentId) {
    return people.filter(p => p.motherId === parentId || p.fatherId === parentId);
}

// Recursive tree builder
function createPersonTree(person) {
    if (displayed.has(person.id)) return null;
    displayed.add(person.id);

    const container = document.createElement('div');
    container.style.display = 'flex';
    container.style.flexDirection = 'column';
    container.style.alignItems = 'center';
    container.style.position = 'relative';

    // Person + spouse
    const spouseDiv = document.createElement('div');
    spouseDiv.className = 'spouse';

    // Self
    const selfDiv = document.createElement('div');
    selfDiv.className = 'person';
    const selfImg = document.createElement('img');
    selfImg.src = person.photo || 'https://via.placeholder.com/80?text=No+Photo';
    const selfName = document.createElement('div');
    selfName.textContent = person.name || '—';
    selfDiv.appendChild(selfImg);
    selfDiv.appendChild(selfName);
    spouseDiv.appendChild(selfDiv);

    // Spouse
    if (person.spouseId) {
        const spouse = people.find(p => p.id === person.spouseId);
        if (spouse && !displayed.has(spouse.id)) {
            const sDiv = document.createElement('div');
            sDiv.className = 'person';
            const sImg = document.createElement('img');
            sImg.src = spouse.photo || 'https://via.placeholder.com/80?text=No+Photo';
            const sName = document.createElement('div');
            sName.textContent = spouse.name || '—';
            sDiv.appendChild(sImg);
            sDiv.appendChild(sName);
            spouseDiv.appendChild(sDiv);
            displayed.add(spouse.id);
        }
    }

    container.appendChild(spouseDiv);

    // Children
    const children = getChildren(person.id);
    if (children.length) {
        const childrenContainer = document.createElement('div');
        childrenContainer.className = 'children';

        // Vertical line
        const vLine = document.createElement('div');
        vLine.className = 'line-vertical';
        spouseDiv.appendChild(vLine);

        // Horizontal line
        const hLine = document.createElement('div');
        hLine.className = 'line-horizontal';
        hLine.style.width = `${children.length * 120}px`;
        childrenContainer.appendChild(hLine);

        children.forEach(child => {
            const childTree = createPersonTree(child);
            if (childTree) {
                childTree.style.margin = '0 10px';
                childrenContainer.appendChild(childTree);
            }
        });

        container.appendChild(childrenContainer);
    }

    return container;
}

// Build the tree
function buildTree() {
    displayed.clear();
    const tree = document.getElementById('familyTree');
    tree.innerHTML = '';
    const roots = people.filter(p => !p.motherId && !p.fatherId);
    roots.forEach(root => {
        const node = createPersonTree(root);
        if (node) tree.appendChild(node);
    });
}

// Firebase real-time listener
onSnapshot(collection(db, "family"), snap => {
    people = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    buildTree();
});
</script>

</body>
</html>
