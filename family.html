<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Family Tree - Courage's Site</title>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;700&display=swap" rel="stylesheet">
<style>
  body { 
    font-family: 'Crimson Text', serif; 
    background: #f4f1ea; 
    padding: 20px; 
    color: #333; 
    transition: background 0.3s, color 0.3s; 
  }
  .tree { 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
  }
  .person { 
    border: 1px solid #333; 
    border-radius: 8px; 
    padding: 10px 15px; 
    min-width: 100px; 
    text-align: center; 
    background: #fff; 
    position: relative; 
    font-weight: bold;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .person img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    margin-bottom: 5px;
    object-fit: cover;
  }
  .spouse { 
    display: flex; 
    gap: 10px; 
    position: relative; 
    margin-bottom: 20px;
  }
  .children { 
    display: flex; 
    justify-content: center; 
    position: relative; 
    margin-top: 20px; 
  }
  .line-down { 
    position: absolute; 
    width: 2px; 
    background: #333; 
    top: 100%; 
    left: 50%;
  }
  .line-horizontal { 
    position: absolute; 
    height: 2px; 
    background: #333; 
    top: 0; 
    left: 0; 
  }
  button { 
    margin-right: 10px; 
    padding: 5px 10px; 
    border: none; 
    border-radius: 3px; 
    cursor: pointer; 
  }
  #controls { margin-bottom: 20px; }
</style>
</head>
<body>

<h2>Family Tree</h2>

<div id="controls">
    <button id="toggleTheme">Toggle Day/Night</button>
    <button id="adminPage">Admin Page</button>
</div>

<div class="tree" id="familyTree"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

// --- Firebase Initialization ---
const firebaseConfig = {
    apiKey: "AIzaSyD00bj-hV8VSdJxAyCdqqpT7VWDMb9qNTQ",
    projectId: "family-tree-aec4a"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- Global variables ---
let people = [];

// --- Day/Night toggle ---
let darkMode = false;
document.getElementById('toggleTheme').addEventListener('click', () => {
    darkMode = !darkMode;
    document.body.style.background = darkMode ? '#333' : '#f4f1ea';
    document.body.style.color = darkMode ? '#f4f1ea' : '#333';
});

// --- Admin page button ---
document.getElementById('adminPage').addEventListener('click', () => {
    window.location.href = 'add-family.html';
});

// --- Helper: find children ---
function getChildren(parentId) {
    return people.filter(p => p.motherId === parentId || p.fatherId === parentId);
}

// --- Create person tree recursively ---
function createPersonTree(person, drawn = new Set()) {
    // Prevent duplicates if spouse has already been drawn
    if (drawn.has(person.id)) return null;
    drawn.add(person.id);

    const container = document.createElement('div');
    container.style.display = 'flex';
    container.style.flexDirection = 'column';
    container.style.alignItems = 'center';
    container.style.position = 'relative';

    // Person + spouse
    const spouseDiv = document.createElement('div');
    spouseDiv.className = 'spouse';

    const selfDiv = document.createElement('div');
    selfDiv.className = 'person';
    const img = document.createElement('img');
    img.src = person.photo || 'https://via.placeholder.com/60'; // placeholder
    selfDiv.appendChild(img);
    const nameSpan = document.createElement('span');
    nameSpan.textContent = person.name || '—';
    selfDiv.appendChild(nameSpan);
    spouseDiv.appendChild(selfDiv);

    if (person.spouseId) {
        const spouse = people.find(x => x.id === person.spouseId);
        if (spouse && !drawn.has(spouse.id)) {
            drawn.add(spouse.id);
            const sDiv = document.createElement('div');
            sDiv.className = 'person';
            const sImg = document.createElement('img');
            sImg.src = spouse.photo || 'https://via.placeholder.com/60';
            sDiv.appendChild(sImg);
            const sName = document.createElement('span');
            sName.textContent = spouse.name || '—';
            sDiv.appendChild(sName);
            spouseDiv.appendChild(sDiv);
        }
    }

    container.appendChild(spouseDiv);

    // Children
    const children = getChildren(person.id);
    if (children.length) {
        const lineDown = document.createElement('div');
        lineDown.className = 'line-down';
        lineDown.style.height = '20px';
        spouseDiv.appendChild(lineDown);

        const childrenContainer = document.createElement('div');
        childrenContainer.className = 'children';

        const hLine = document.createElement('div');
        hLine.className = 'line-horizontal';
        hLine.style.width = `${children.length * 120}px`;
        childrenContainer.appendChild(hLine);

        children.forEach(child => {
            const childTree = createPersonTree(child, drawn);
            if (childTree) {
                childTree.style.margin = '0 10px';
                childrenContainer.appendChild(childTree);
            }
        });

        container.appendChild(childrenContainer);
    }

    return container;
}

// --- Build tree ---
function buildTree() {
    const tree = document.getElementById('familyTree');
    tree.innerHTML = '';
    const drawn = new Set();
    const roots = people.filter(p => !p.motherId && !p.fatherId);
    roots.forEach(root => {
        const treeNode = createPersonTree(root, drawn);
        if (treeNode) tree.appendChild(treeNode);
    });
}

// --- Real-time Firebase updates ---
onSnapshot(collection(db, "family"), snap => {
    people = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    buildTree();
});
</script>

</body>
</html>
